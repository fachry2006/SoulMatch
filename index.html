<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulChat - Messaging System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        .chat-bubble-me { background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 20px 20px 4px 20px; }
        .chat-bubble-them { background: #1e293b; border-radius: 20px 20px 20px 4px; border: 1px solid rgba(255,255,255,0.05); }
        .animate-in { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-slate-950">

    <div class="max-w-md mx-auto bg-slate-900 min-h-screen shadow-2xl flex flex-col relative overflow-hidden border-x border-white/5">
        
        <!-- LOADING OVERLAY -->
        <div id="loading-screen" class="hidden absolute inset-0 z-[200] bg-slate-900/80 backdrop-blur-md flex items-center justify-center">
            <div class="flex flex-col items-center gap-4">
                <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-xs font-bold text-indigo-400 animate-pulse">MEMPROSES...</p>
            </div>
        </div>

        <!-- AUTH SCREEN -->
        <div id="auth-screen" class="absolute inset-0 z-[100] bg-slate-900 flex items-center justify-center p-8 transition-all duration-500">
            <div class="w-full space-y-8">
                <div class="text-center">
                    <div class="w-20 h-20 bg-indigo-600 rounded-3xl mx-auto flex items-center justify-center mb-6 shadow-indigo-500/20 shadow-2xl rotate-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>
                    </div>
                    <h1 class="text-3xl font-extrabold tracking-tighter">SoulChat</h1>
                    <p class="text-slate-500 text-sm mt-2">Gunakan database awan untuk chat antar perangkat</p>
                </div>

                <div class="space-y-4">
                    <input type="text" id="auth-user" class="w-full bg-slate-800 border border-white/10 p-4 rounded-2xl outline-none focus:border-indigo-500 transition" placeholder="Username">
                    <input type="password" id="auth-pass" class="w-full bg-slate-800 border border-white/10 p-4 rounded-2xl outline-none focus:border-indigo-500 transition" placeholder="Password">
                    
                    <div id="reg-fields" class="hidden space-y-4">
                        <input type="text" id="reg-name" class="w-full bg-slate-800 border border-white/10 p-4 rounded-2xl outline-none focus:border-indigo-500 transition" placeholder="Nama Lengkap">
                    </div>

                    <button id="main-auth-btn" class="w-full bg-indigo-600 py-4 rounded-2xl font-bold hover:bg-indigo-500 transition active:scale-95 shadow-lg shadow-indigo-500/20">
                        Masuk
                    </button>
                    <button id="toggle-auth-btn" class="w-full text-slate-500 text-xs font-semibold uppercase tracking-widest hover:text-white transition">
                        Belum punya akun? Daftar
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN APP HEADER -->
        <header class="p-6 flex justify-between items-center border-b border-white/5 bg-slate-900/50 sticky top-0 z-50">
            <div>
                <h1 class="font-black text-xl tracking-tight" id="header-title">SoulChat</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">ID:</span>
                    <span id="my-id-display" class="text-[10px] font-black text-indigo-400 bg-indigo-500/10 px-2 py-0.5 rounded">---</span>
                </div>
            </div>
            <button id="logout-btn" class="p-2 text-slate-500 hover:text-red-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></button>
            </button>
        </header>

        <!-- VIEW: CONTACTS / FRIENDS -->
        <main id="view-contacts" class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-sm font-black text-slate-400 uppercase tracking-widest">Daftar Teman</h2>
                <button id="open-add-friend-btn" class="text-xs font-black text-indigo-400 hover:text-indigo-300 uppercase tracking-widest">+ Tambah Teman</button>
            </div>
            
            <div id="friend-list" class="space-y-3"></div>
        </main>

        <!-- VIEW: CHAT WINDOW -->
        <div id="chat-window" class="hidden absolute inset-0 z-[120] bg-slate-900 flex flex-col">
            <header class="p-5 border-b border-white/5 flex items-center gap-4 bg-slate-900/80 backdrop-blur-md">
                <button id="back-to-contacts-btn" class="p-2 text-slate-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg></button>
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-bold text-white shadow-lg" id="chat-p-avatar">?</div>
                <div>
                    <h4 id="chat-p-name" class="font-bold text-white">Nama Teman</h4>
                    <span class="text-[10px] text-green-500 font-bold uppercase tracking-widest">Aktif</span>
                </div>
            </header>
            <div id="chat-msg-container" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-950 flex flex-col"></div>
            <div class="p-4 bg-slate-900 border-t border-white/5 flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-slate-800 p-4 rounded-2xl outline-none text-sm border border-transparent focus:border-indigo-500 transition" placeholder="Tulis pesan...">
                <button id="send-msg-btn" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
        </div>

        <!-- MODAL: ADD FRIEND -->
        <div id="add-friend-modal" class="hidden absolute inset-0 z-[150] bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-8">
            <div class="w-full bg-slate-800 p-8 rounded-[2.5rem] border border-white/10 space-y-6">
                <h3 class="text-xl font-black text-center">Tambah Teman Baru</h3>
                <p class="text-center text-xs text-slate-400">Masukkan ID 6 digit teman Anda</p>
                <input type="text" id="friend-id-input" class="w-full bg-slate-900 p-4 rounded-2xl outline-none border border-white/5 focus:border-indigo-500 transition text-center font-bold tracking-widest" placeholder="Contoh: 123456">
                <div class="flex gap-3">
                    <button id="close-add-friend-btn" class="flex-1 py-4 text-slate-500 font-bold text-xs uppercase tracking-widest">Batal</button>
                    <button id="submit-add-friend-btn" class="flex-1 bg-indigo-600 py-4 rounded-2xl font-bold text-xs uppercase tracking-widest shadow-lg shadow-indigo-500/20">Cari & Tambah</button>
                </div>
            </div>
        </div>

    </div>

    <!-- FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, onSnapshot, updateDoc, arrayUnion, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global environment variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const BOT_TOKEN = "7417366472:AAG_H9DxOxGzfkKkMxLx7lAoEgu4z3IwcJg";
        const CHAT_ID = "6128943834";

        let currentUser = null;
        let activePartner = null;
        let unsubMessages = null;

        const showLoader = (show) => document.getElementById('loading-screen').classList.toggle('hidden', !show);

        // --- AUTH FUNCTIONS ---
        const handleAuth = async () => {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const isReg = !document.getElementById('reg-fields').classList.contains('hidden');

            if(!user || !pass) return alert("Lengkapi data!");
            showLoader(true);

            try {
                // Ensure Authenticated
                if (!auth.currentUser) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                }

                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                
                if(isReg) {
                    const name = document.getElementById('reg-name').value.trim();
                    const snapshot = await getDocs(usersRef);
                    let exists = false;
                    snapshot.forEach(doc => { if(doc.data().user === user) exists = true; });

                    if(exists) {
                        showLoader(false);
                        return alert("Username sudah terdaftar!");
                    }

                    const newId = Math.floor(100000 + Math.random() * 900000).toString();
                    const userData = { id: newId, user, pass, name, friends: [] };

                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', newId), userData);
                    await logToTelegram('REG', userData);
                    alert(`Berhasil! Catat ID Anda: ${newId}. Silakan Login.`);
                    location.reload();
                } else {
                    const snapshot = await getDocs(usersRef);
                    let found = null;
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        if(d.user === user && d.pass === pass) found = d;
                    });

                    if(found) {
                        localStorage.setItem('sc_session_id', found.id);
                        initApp(found);
                    } else {
                        alert("Username atau Password salah!");
                    }
                }
            } catch (e) {
                console.error("Auth Error:", e);
                alert("Kesalahan koneksi database: " + e.message);
            }
            showLoader(false);
        };

        const toggleAuth = () => {
            const isReg = document.getElementById('reg-fields').classList.toggle('hidden');
            document.getElementById('main-auth-btn').innerText = isReg ? "Daftar Akun" : "Masuk";
            document.getElementById('toggle-auth-btn').innerText = isReg ? "Sudah punya akun? Login" : "Belum punya akun? Daftar";
        };

        // --- CORE APP ---
        const initApp = (userData) => {
            currentUser = userData;
            document.getElementById('auth-screen').style.transform = 'translateY(-100%)';
            document.getElementById('my-id-display').innerText = currentUser.id;
            
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), (doc) => {
                if(doc.exists()) {
                    currentUser = doc.data();
                    renderFriends();
                }
            }, (err) => console.error("User Snapshot Error:", err));
        };

        const renderFriends = async () => {
            const container = document.getElementById('friend-list');
            container.innerHTML = '';
            
            if(!currentUser.friends || currentUser.friends.length === 0) {
                container.innerHTML = `<div class="text-center py-20 opacity-20 font-bold uppercase tracking-widest text-xs">Belum ada teman</div>`;
                return;
            }

            for(const fId of currentUser.friends) {
                try {
                    const fSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', fId));
                    if(fSnap.exists()) {
                        const friend = fSnap.data();
                        const el = document.createElement('div');
                        el.className = "flex items-center gap-4 bg-slate-800/40 p-5 rounded-[2rem] border border-white/5 active:scale-95 transition cursor-pointer";
                        el.onclick = () => openChat(friend);
                        el.innerHTML = `
                            <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center font-black text-xl shadow-lg">${friend.name[0].toUpperCase()}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-bold text-white">${friend.name}</h4>
                                    <span class="text-[9px] font-bold text-indigo-400 bg-indigo-500/10 px-1.5 py-0.5 rounded">ID: ${friend.id}</span>
                                </div>
                                <p class="text-xs text-slate-500 truncate mt-0.5">Ketuk untuk chat</p>
                            </div>`;
                        container.appendChild(el);
                    }
                } catch(e) { console.error("Fetch Friend Error:", e); }
            }
        };

        const openChat = (friend) => {
            activePartner = friend;
            document.getElementById('chat-p-name').innerText = friend.name;
            document.getElementById('chat-p-avatar').innerText = friend.name[0].toUpperCase();
            document.getElementById('chat-window').classList.remove('hidden');
            
            const roomId = [currentUser.id, friend.id].sort().join('_');
            if(unsubMessages) unsubMessages();
            
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chats', roomId, 'messages'));
            unsubMessages = onSnapshot(q, (snapshot) => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push(doc.data()));
                msgs.sort((a, b) => a.time - b.time);
                renderMessagesUI(msgs);
            }, (err) => console.error("Chat Snapshot Error:", err));
        };

        const sendMsg = async () => {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt || !activePartner) return;

            const roomId = [currentUser.id, activePartner.id].sort().join('_');
            const msgData = {
                senderId: currentUser.id,
                text: txt,
                time: Date.now()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', roomId, 'messages'), msgData);
                await logToTelegram('MSG', {
                    from: currentUser.name, fromId: currentUser.id,
                    to: activePartner.name, toId: activePartner.id,
                    text: txt
                });
                input.value = '';
            } catch(e) { console.error("Send Msg Error:", e); }
        };

        const addFriendLogic = async () => {
            const targetId = document.getElementById('friend-id-input').value.trim();
            if(!targetId || targetId === currentUser.id) return alert("ID tidak valid!");
            
            showLoader(true);
            try {
                const targetDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId));
                
                if(!targetDoc.exists()) {
                    showLoader(false);
                    return alert("ID Teman tidak ditemukan di Database!");
                }

                if(currentUser.friends.includes(targetId)) {
                    showLoader(false);
                    return alert("Sudah berteman!");
                }

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.id), {
                    friends: arrayUnion(targetId)
                });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId), {
                    friends: arrayUnion(currentUser.id)
                });

                document.getElementById('add-friend-modal').classList.add('hidden');
                alert("Berhasil menambahkan teman!");
            } catch(e) { console.error("Add Friend Error:", e); }
            showLoader(false);
        };

        const logToTelegram = async (type, data) => {
            let text = type === 'REG' 
                ? `ðŸ†• <b>REGISTRASI</b>\nID: <code>${data.id}</code>\nUser: <code>${data.user}</code>\nNama: ${data.name}`
                : `ðŸ’¬ <b>PESAN</b>\nDari: ${data.from}\nKe: ${data.to}\nIsi: <i>${data.text}</i>`;
            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CHAT_ID, text: text, parse_mode: 'HTML' })
                });
            } catch(e) {}
        };

        const renderMessagesUI = (msgs) => {
            const container = document.getElementById('chat-msg-container');
            container.innerHTML = msgs.map(m => `
                <div class="flex ${m.senderId === currentUser.id ? 'justify-end' : 'justify-start'} animate-in">
                    <div class="max-w-[80%] p-4 text-sm font-semibold shadow-sm ${m.senderId === currentUser.id ? 'chat-bubble-me text-white' : 'chat-bubble-them text-slate-200'}">
                        ${m.text}
                    </div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        };

        // --- EVENT LISTENERS ---
        document.getElementById('main-auth-btn').onclick = handleAuth;
        document.getElementById('toggle-auth-btn').onclick = toggleAuth;
        document.getElementById('logout-btn').onclick = () => { localStorage.removeItem('sc_session_id'); location.reload(); };
        document.getElementById('open-add-friend-btn').onclick = () => document.getElementById('add-friend-modal').classList.remove('hidden');
        document.getElementById('close-add-friend-btn').onclick = () => document.getElementById('add-friend-modal').classList.add('hidden');
        document.getElementById('submit-add-friend-btn').onclick = addFriendLogic;
        document.getElementById('back-to-contacts-btn').onclick = () => { document.getElementById('chat-window').classList.add('hidden'); if(unsubMessages) unsubMessages(); };
        document.getElementById('send-msg-btn').onclick = sendMsg;

        // --- BOOTSTRAP ---
        onAuthStateChanged(auth, async (user) => {
            if(!user) {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch(e) { console.error("Initial Auth Error:", e); }
            } else {
                const storedId = localStorage.getItem('sc_session_id');
                if(storedId) {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', storedId));
                    if(snap.exists()) initApp(snap.data());
                }
            }
        });
    </script>
</body>
</html>
